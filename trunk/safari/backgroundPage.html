<!DOCTYPE html>
<html>
	<head>
		<script src = 'tabManager.js' type = 'text/javascript'></script>
		<script src = 'imageForAction.js' type = 'text/javascript'></script>
		<script type = 'text/javascript'>
			/*	Marking Menu JS
			 *	by Brenton Simpson
			 *	bsimpson@appsforartists.com
			 *	7/24/2011
			 */
						
			var settings = {
				'_cache': {},
				
				'get': function(key) {
					if (_cache.hasOwnProperty(key))
						return _cache[key];
					
					switch (key) {
						case 'firstRun':
							// There are defaults in Settings.plist, so they never need to be reloaded from defaultSettings.js
							return storeInCache(false);

						case 'actions':
							var actions = [];
				
							for (var i = 0, keepGoing = true; keepGoing; i++) {
								try {
									var nextAction = safari.extension.settings['action' + i];
									actions.push(nextAction);
								} catch (error) {
									//When you run out of actions, you get an error
									keepGoing = false;
								}
							}
							
							return storeInCache(actions);

						case 'actionImages':
							var actionImages = settings.get('actions').map(imageForAction);
							return storeInCache(actionImages);

						default:
							return storeInCache(safari.extension.settings[key]);
					}
					
					function storeInCache(value) {
						_cache[key] = value;
						
						return value;
					}
				},
						
				'set': function(key, value) {
					switch (key) {
						case 'actions':
							for (var i = 0; i < value.length; i++)
								safari.extension.settings['action' + i] = value[i];

							break;
		
						case 'actionImages':
							break;

						default:
							safari.extension.settings[key] = value;
							break;
					}
					
					_cache[key] = value;
				},
				
				'clearCache': function() {
					_cache = {};
				}
			}
			
			function onMessage(event) {
				/*	If this message is a response to an earlier request, call the appropriate
				 *	callback with the arguments sent back from the background page.
				 */
	
				var action = event.name;
				var message = event.data;
				
				switch (action) {
					case 'settings.get':
						sendResponse(
							action, [
								{
									'key': message.key,
									'value': settings.get(message.key)
								}
							]
						);
						break;

					case 'settings.set':
						settings.set(message.key, message.value);
						sendResponse(action);
						break;
						
					default:
						sendResponse(action);
						break;
				}
			}
			
			function sendResponse(originalAction, arguments) {
				arguments = arguments || [];
				
				safari.self.tab.dispatchMessage('response:' + originalAction, arguments);
			}
			
			safari.self.addEventListener('message', onMessage);
		</script>
	</head>
</html>